#!/bin/bash

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${OMARCHY_SCREENSHOT_DIR:-${XDG_PICTURES_DIR:-$HOME/Pictures}}"

modes="region,window,output"
mode=""
extra_args=()

while test $# -gt 0; do
  case "$1" in
  -m | --mode)
    shift
    mode="$1"
    ;;
  *)
    extra_args+=("$1")
    ;;
  esac
  shift
done

if [[ -z "$mode" ]]; then
  modes="$(echo "$modes" | sed 's/,/\\n/g')"
  mode="$(echo -e $modes | dmenu)"

  if [[ "$mode" == "output" ]]; then
    monitor="$(hyprctl monitors -j | jq -r '.[].name' | dmenu)"
    mode="output --mode $monitor"
  fi
fi

sleep 0.1 && hyprshot --mode $mode "${extra_args[@]}" --freeze --raw | satty --filename - \
  --output-filename "$OUTPUT_DIR/screenshot-$(date +'%Y-%m-%d_%H-%M-%S').png" \
  --early-exit \
  --actions-on-enter save-to-clipboard \
  --actions-on-escape exit \
  --copy-command 'wl-copy'
