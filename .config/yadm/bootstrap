#!/bin/sh
# vim: set ft=sh sw=4 et :

# Source scripts/*.sh
for script in $HOME/.config/yadm/scripts/*.sh; do
    if [ -f "$script" ]; then
        echo "Sourcing $script"
        . $script
    fi
done

package_files_dir="$HOME/.config/yadm/packages/*.list"

install_packages () {
    for package_file in $package_files_dir; do
        if [ -f "$package_file" ]; then
            echo "Installing packages from $package_file"
            yay -S --needed --noconfirm - < $package_file
        fi
    done
}

enable_services () {
    systemctl --user enable --now pi-hole
    systemctl --user enable --now wallpaper.timer
    systemctl --user enable --now run-mount-scripts.timer
}

configure_docker () {
tee $HOME/.docker/config.json &>/dev/null <<EOF
    {
        "credsStore": "secretservice"
    }
EOF
sudo usermod -aG docker $USER
}

clean_slate() {
    echo "Cleaning up"
    yay -Scc --noconfirm

    echo "Updating repositories"
    yay -Syy
}

ask () {
    if [ "$INSTALL_ALL" = "yes" ]; then
        return 0
    fi

    read -p "$1? [y/N] " -n 1 -r
    echo   # (optional) move to a new line
}

yadm alt
clean_slate

INSTALL_ALL=no

# Parse arguments
while [ $# -gt 0 ]; do
    case $1 in
        --all) INSTALL_ALL=yes;
    esac
    shift
done

if [[ $INSTALL_ALL = "no" ]]; then
    read -p "Run all scripts? [y/N] " -n 1 -r
    echo   # (optional) move to a new line
    if [[ $REPLY =~ ^[Yy]$ ]]
    then
        INSTALL_ALL=yes
    fi
fi

# Ask if user wants to install packages
ask "Install packages"
if [[ $REPLY =~ ^[Yy]$ ]]
then
    install_packages
fi

# Ask if user wants to configure vim
ask "Configure vim"
if [[ $REPLY =~ ^[Yy]$ ]]
then
    configure_vim
else
    ask "Update vim plugins"
    if [[ $REPLY =~ ^[Yy]$ ]]
    then
        update_vim_plugins
    fi
fi

# Ask if user wants to install zsh
ask "Install zsh"
if [[ $REPLY =~ ^[Yy]$ ]]
then
    install_zsh
else
    ask "Update zsh"
    if [[ $REPLY =~ ^[Yy]$ ]]
    then
        update_zsh
    fi
fi

# Ask if user wants to enable system services
ask "Enable system services"
if [[ $REPLY =~ ^[Yy]$ ]]
then
    enable_system_services
fi

# Ask if user wants to enable services
ask "Enable user services"
if [[ $REPLY =~ ^[Yy]$ ]]
then
    enable_services
fi

# Ask if user wants to configure resolvconf
ask "Configure resolvconf"
if [[ $REPLY =~ ^[Yy]$ ]]
then
    configure_resolvconf
fi

# Ask if user wants to configure docker
ask "Configure docker"
if [[ $REPLY =~ ^[Yy]$ ]]
then
    configure_docker
fi
