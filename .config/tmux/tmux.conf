# vim: ft=tmux
# Start window and pane indices at 1
set -g base-index 1
setw -g pane-base-index 1

# Don’t exit tmux when the last session is closed
set -g detach-on-destroy off

# Input responsiveness
set -g escape-time 0

# Increase scrollback history
set -g history-limit 100000

# Enable mouse support
set -g mouse on

# Automatically renumber windows after closing one
set -g renumber-windows on

# Integrate with system clipboard
set -g set-clipboard on

# Enable focus events (useful for Vim/Neovim)
set -g focus-events on

# Set window titles in terminal tab
set -g set-titles on
set -g set-titles-string "#S / #W"

set -g default-terminal "screen-256color"
set -ga terminal-overrides ",*256col*:Tc"
set -as terminal-features 'xterm*:extkeys'

# Allow passthrough for OSC sequences (for better clipboard and title integration)
set -g allow-passthrough on

# Update environment when reattaching
set -ag update-environment TERM
set -ag update-environment TERM_PROGRAM
set -ag update-environment SSH_AUTH_SOCK

set -g status-position "top"
set -g status-justify "absolute-centre"

# Refresh the status line every few seconds
set -g status-interval 3

# emacs key bindings in tmux command prompt (prefix + :) are better than
# vi keys, even for vim users
set -g status-keys emacs

# vim-tpipeline
set -g status-left-length 100
set -g status-right-length 100

# Dracula Color Palette
white="#f8f8f2"
gray="#44475a"
dark_gray="#282a36"
light_purple="#bd93f9"
dark_purple="#6272a4"
cyan="#8be9fd"
green="#50fa7b"
orange="#ffb86c"
red="#ff5555"
purple="#b166cc"
pink="#ff79c6"
yellow="#f1fa8c"

bg="$dark_gray"
fg="$dark_purple"
selection="$light_purple"

set -g pane-border-style "fg=$fg"
set -g pane-active-border-style "fg=$selection"

set -g status-style "bg=${bg},fg=${fg},nobold"
set -g window-status-style "bg=${bg},fg=${fg}"
set -g window-status-bell-style "bg=${selection},fg=${bg},nobold"
set -g window-status-activity-style "bg=${white},fg=${bg}"
set -g message-style "bg=${bg},fg=${fg}"
set -g message-command-style "bg=${bg},fg=${fg}"

maximized_pane_icon='󰊓'
window_status_format=' #W '
session_status_format=' #S '

status_left="#[bg=$bg,fg=$green,bold]#{?client_prefix,,${session_status_format}}#[bg=$green,fg=$bg]#{?client_prefix,${session_status_format},}#[bg=$bg,fg=$green]"
nvim_statusline_left='#(cat #{socket_path}-\#{session_id}-vimbridge)'
set -g status-left "$status_left$nvim_statusline_left"

status_right="#[bg=$selection,fg=$bg,nobold]#[bg=$bg,fg=$fg,nobold] @#(hostname -f)"
nvim_statusline_right='#(cat #{socket_path}-\#{session_id}-vimbridge-R)'
set -g status-right "$nvim_statusline_right$status_right"

setw -g window-status-separator ' • '
window_status="${window_status_format}#{?window_zoomed_flag,${maximized_pane_icon},}"
set -g window-status-format "$window_status"
set -g window-status-current-format "#[bg=${bg},fg=${white},nobold]$window_status"

set -g extended-keys on
set -g extended-keys-format csi-u

# Use vi-style keys in copy mode
setw -g mode-keys vi

# Use Ctrl-A as the tmux prefix
unbind C-b
set -g prefix C-a

# Reload config easily
bind r source-file ~/.config/tmux/tmux.conf \; display "reloaded!"

# Split panes relative to current path
bind -n C-t new-window -c "#{pane_current_path}"
bind -n M-f resize-pane -Z
bind -n C-Enter split-window -h -c "#{pane_current_path}"
bind -n C-\\ split-window -fh -c "#{pane_current_path}"
bind -n M-Enter split-window -v -c "#{pane_current_path}"
bind -n M-\\ split-window -fv -c "#{pane_current_path}"
bind -n BTab switch-client -l

bind -n C-PageUp previous-window
bind -n C-PageDown next-window
bind -n C-Tab last-window

# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
vim_pattern='(\S+/)?g?\.?(view|l?n?vim?x?|fzf)(diff)?(-wrapped)?'
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +${vim_pattern}$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R

pane_resize="5"
bind -nr M-h resize-pane -L "$pane_resize"
bind -nr M-j resize-pane -D "$pane_resize"
bind -nr M-k resize-pane -U "$pane_resize"
bind -nr M-l resize-pane -R "$pane_resize"

bind -nr C-S-Left swap-pane -U
bind -nr C-S-Right swap-pane -D

# Custom shortcuts
bind -n C-e new-window -c "#{pane_current_path}" -n 'editor' "$EDITOR"
bind -n M-e new-window -c "$HOME" -n 'dotfiles' "yadm enter $EDITOR"
bind -n C-b new-window -n 'btop' 'btop'

# smart lazygit
bind -n C-g popup -d '#{pane_current_path}' -E -w 90% -h 90% fish -c 'gg'

# External helper scripts
bind -n C-n run-shell "sesh-connect"
bind -n M-t run-shell "~/.config/tmux/scripts/make-fzf.sh"
bind -n C-d run-shell "~/.config/tmux/scripts/kill_pane.sh '#{pane_current_command}' $SHELL"

bind -n C-1 select-window -t :=1
bind -n C-2 select-window -t :=2
bind -n C-3 select-window -t :=3

# TPM plugin manager
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'

# Resurrect: persist specific processes
set -g @resurrect-processes 'nvim "~bandwhich" "~nethogs" nvtop btop watch'

# Initialize TPM (must stay last)
if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins all'"
run -b '~/.config/tmux/plugins/tpm/tpm'
